<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>트랙 | TexTune</title>
    <style>
      :root{
        --bg:#0f1222; --panel:#191c33; --panel2:#14172a; --stroke:#2a2f55; --text:#e8e8f0; --muted:#aab; --brand:#8ad;
        --grad1:#a65cff; --grad2:#4b63ff; --sidebar:#0b0d1a;
      }
      *{box-sizing:border-box}
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text);display:flex;min-height:100vh;position:relative;overflow:hidden}
      .bg-glow{position:fixed;inset:0;pointer-events:none;background:
        radial-gradient(40% 35% at 50% 55%, rgba(166,92,255,0.35), transparent 60%),
        radial-gradient(32% 32% at 60% 60%, rgba(75,99,255,0.25), transparent 58%),
        radial-gradient(30% 28% at 40% 40%, rgba(255,77,50,0.18), transparent 60%);
        filter:blur(10px);z-index:0}
      .layout{display:flex;width:100%;position:relative;z-index:1}
      .sidebar{width:220px;min-height:100vh;background:var(--sidebar);border-right:1px solid var(--stroke);padding:18px 14px;position:sticky;top:0;align-self:flex-start}
      .side-brand{display:flex;align-items:center;gap:10px;margin-bottom:18px;font-weight:800;color:var(--text);text-decoration:none}
      .side-logo{width:34px;height:34px;border-radius:12px;background:linear-gradient(135deg,var(--grad1),var(--grad2));display:grid;place-items:center;font-weight:800;color:#fff}
      .side-nav{display:flex;flex-direction:column;gap:8px;margin-top:12px}
      .side-nav a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:var(--text);text-decoration:none;border:1px solid transparent}
      .side-nav a:hover{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.08)}
      .side-nav a.active{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.1)}
      #authUser{color:var(--muted);font-size:12px;margin-top:16px;display:block}
      .main{flex:1;padding:32px 32px 48px}
      .card{background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:18px;margin:12px auto;max-width:820px}
      .btn{background:#4b63ff;color:#fff;border:none;border-radius:8px;padding:10px 14px;cursor:pointer}
      .meta{font-size:14px;opacity:.85}
      code{background:#0f1222;border:1px solid #2a2f55;padding:2px 4px;border-radius:4px}
    </style>
  </head>
  <body>
    <div class="bg-glow" aria-hidden="true"></div>
    <div class="layout">
      <aside class="sidebar">
        <a class="side-brand" href="/">
          <div class="side-logo">TT</div>
          <span>TexTune</span>
        </a>
        <nav class="side-nav">
          <a href="/">홈</a>
          <a href="generate.html">음원 생성</a>
          <a href="library.html" class="active">보관함</a>
          <a id="authAction" href="#">로그인</a>
        </nav>
        <span id="authUser"></span>
      </aside>
      <main class="main">
        <div class="card" id="card">
          <h2 id="title">트랙</h2>
          <div id="player"></div>
          <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
            <a id="download" class="btn" href="#">다운로드</a>
            <button id="regen" class="btn">같은 프롬프트로 다시 생성</button>
          </div>
          <div class="meta" id="meta" style="margin-top:12px"></div>
        </div>
      </main>
    </div>

    <script src="js/app.js"></script>
    <script>
      function escapeHtml(str = '') {
        return str.replace(/[&<>"']/g, c => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
        })[c] || c);
      }

      (async () => {
        await hydrateAuthControls();
        await ensureAuthed();
        const params = new URLSearchParams(location.search);
        const id = params.get('id');
        if (!id) { document.getElementById('card').innerHTML = '<p>잘못된 요청</p>'; return; }
        try {
          const t = await api(`/v1/tracks/${id}`);
          const title = t.prompt_title || `트랙 #${id.slice(0,8)}`;
          document.getElementById('title').textContent = title;
          document.title = `${title} | TexTune`;
          document.getElementById('player').innerHTML = `<audio controls src="${t.audio_url}" style="width:100%"></audio>`;
          document.getElementById('download').href = t.download_url;
          document.getElementById('meta').innerHTML = `
            <div>길이: <code>${t.duration}s</code> / 샘플레이트: <code>${t.samplerate}</code> / 포맷: <code>${t.format}</code></div>
            <div style='margin-top:6px'>프롬프트: <code>${escapeHtml(t.prompt_raw||'')}</code></div>
            <div class='muted'>확장: <code>${escapeHtml(t.prompt_expanded||'')}</code></div>
          `;

          document.getElementById('regen').addEventListener('click', async () => {
            try {
              const { job_id } = await api('/v1/generations', { method: 'POST', body: {
                prompt: t.prompt_raw, duration: t.duration, samplerate: t.samplerate, seed: t.params?.seed ?? null, quality: t.params?.quality || 'draft'
              }});
              alert('재생성이 시작되었습니다. 생성 페이지에서 확인해주세요.');
              window.location.href = 'generate.html';
            } catch(e) { alert('오류: '+e.message); }
          });
        } catch (e) {
          document.getElementById('card').innerHTML = '<p>트랙을 불러오지 못했습니다.</p>';
        }
      })();
    </script>
  </body>
</html>
