<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>보관함 — TextTune</title>
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:24px;background:#0f1222;color:#e8e8f0}
      header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
      a{color:#8ad;text-decoration:none}
      .brand{display:flex;align-items:center;gap:10px;color:#fff;font-weight:700}
      .logo{width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,#a65cff,#4b63ff);display:grid;place-items:center;color:#fff;font-size:20px;box-shadow:0 6px 16px rgba(75,99,255,.35)}
      .group{margin-bottom:32px}
      .group-title{margin:0 0 8px;font-size:18px;font-weight:700}
      .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
      .card{background:#191c33;border:1px solid #2a2f55;border-radius:12px;padding:12px}
      .card-head{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:6px}
      .title{font-weight:600;line-height:1.3;word-break:break-word}
      .small{font-size:12px}
      .row{display:flex;justify-content:space-between;align-items:center;gap:8px}
      .btn{background:#4b63ff;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
      .danger{background:#c0392b}
      .muted{opacity:.85}
      .meta{margin-bottom:8px}
      audio{width:100%}
    </style>
  </head>
  <body>
    <header>
      <a class="brand" href="/">
        <div class="logo">♫</div>
        <span>TexTune</span>
      </a>
      <div></div>
    </header>

    <h2>내 보관함</h2>
    <div id="library"></div>

    <script src="js/app.js"></script>
    <script>
      (async () => {
        await ensureAuthed();
        await load();
      })();

      const DATE_FMT = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' };
      const TIME_FMT = { hour: '2-digit', minute: '2-digit', second: '2-digit' };

      function escapeHtml(str = '') {
        return str.replace(/[&<>"']/g, c => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
        })[c] || c);
      }

      function getDateLabel(date) {
        return date.toLocaleDateString('ko-KR', DATE_FMT);
      }

      function getTimeLabel(date) {
        return date.toLocaleTimeString('ko-KR', TIME_FMT);
      }

      async function load() {
        const { items } = await api('/v1/library?limit=20');
        const container = document.getElementById('library');
        container.innerHTML = '';

        const groups = [];
        const map = new Map();
        items.forEach(item => {
          const created = new Date(item.created_at);
          const label = getDateLabel(created);
          if (!map.has(label)) {
            const group = { label, tracks: [] };
            map.set(label, group);
            groups.push(group);
          }
          map.get(label).tracks.push({ ...item, created });
        });

        groups.forEach(group => {
          const section = document.createElement('section');
          section.className = 'group';
          section.innerHTML = `<h3 class="group-title">${group.label}</h3>`;
          const cards = document.createElement('div');
          cards.className = 'cards';

          group.tracks.forEach(t => {
            const title = t.prompt_title || `트랙 #${t.id.slice(0, 8)}`;
            const safeTitle = escapeHtml(title);
            const meta = `${t.duration ?? '?'}s • ${t.samplerate ?? '?'}Hz • ${t.format || '?'}`;
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
              <div class='card-head'>
                <a class='title' href='track.html?id=${t.id}' title='${safeTitle}'>${safeTitle}</a>
                <span class='muted small'>${getTimeLabel(t.created)}</span>
              </div>
              <div class='muted meta'>${escapeHtml(meta)}</div>
              <audio controls src='${t.audio_url}'></audio>
              <div class='row' style='margin-top:8px'>
                <a class='btn' href='${t.download_url}'>다운로드</a>
                <button class='btn danger' data-id='${t.id}'>삭제</button>
              </div>
            `;
            card.querySelector('button[data-id]')?.addEventListener('click', async (e) => {
              const id = e.target.getAttribute('data-id');
              if (!confirm('정말 삭제하시겠어요?')) return;
              await fetch(`/v1/library/${id}`, { method: 'DELETE', credentials: 'include' });
              await load();
            });
            cards.appendChild(card);
          });

          section.appendChild(cards);
          container.appendChild(section);
        });
      }
    </script>
  </body>
  </html>
