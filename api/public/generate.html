<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TexTune | 트랙 생성</title>
    <style>
      :root{
        --bg:#0f1222; --panel:#191c33; --panel2:#14172a; --stroke:#2a2f55; --text:#e8e8f0; --muted:#aab; --brand:#8ad;
        --grad1:#a65cff; --grad2:#4b63ff; --sidebar:#0b0d1a; --accent:#ff4d32;
      }
      *{box-sizing:border-box}
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text);display:flex;min-height:100vh}
      .layout{display:flex;width:100%}
      .sidebar{width:220px;min-height:100vh;background:var(--sidebar);border-right:1px solid var(--stroke);padding:18px 14px;position:sticky;top:0;align-self:flex-start}
      .side-brand{display:flex;align-items:center;gap:10px;margin-bottom:18px;font-weight:800;color:var(--text);text-decoration:none}
      .side-logo{width:34px;height:34px;border-radius:12px;background:linear-gradient(135deg,var(--grad1),var(--grad2));display:grid;place-items:center;font-weight:800;color:#fff}
      .side-nav{display:flex;flex-direction:column;gap:8px;margin-top:12px}
      .side-nav a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:var(--text);text-decoration:none;border:1px solid transparent}
      .side-nav a:hover{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.08)}
      .side-nav a.active{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.1)}
      #authUser{color:var(--muted);font-size:12px;margin-top:16px;display:block}
      main{flex:1;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;padding:32px 32px 48px}
      .glow{position:absolute;inset:0;pointer-events:none;background:
        radial-gradient(40% 35% at 50% 55%, rgba(166,92,255,0.35), transparent 60%),
        radial-gradient(32% 32% at 60% 60%, rgba(75,99,255,0.25), transparent 58%),
        radial-gradient(30% 28% at 40% 40%, rgba(255,77,50,0.18), transparent 60%);
        filter:blur(10px);
      }
      .hero{position:relative;z-index:1;width:100%;max-width:960px;text-align:center;padding:32px 16px 24px}
      .eyebrow{color:var(--muted);font-weight:600;letter-spacing:.02em;margin-bottom:10px}
      .title{font-size:40px;font-weight:800;line-height:1.15;margin:0 0 28px}
      .prompt-shell{background:linear-gradient(120deg,rgba(14,17,29,0.92),rgba(18,21,38,0.92));border:1px solid rgba(255,255,255,0.04);border-radius:22px;padding:16px;display:flex;align-items:flex-start;gap:12px;box-shadow:0 16px 40px rgba(0,0,0,0.32)}
      .prompt-shell .icon-btn{width:38px;height:38px;display:grid;place-items:center;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.06);border-radius:11px;color:#d9dde8;cursor:pointer;padding:0}
      .prompt-shell textarea{flex:1;font-size:17px;line-height:1.4;background:transparent;border:none;color:var(--text);resize:none;outline:none;min-height:64px;padding-top:6px}
      .prompt-actions{display:flex;align-items:center;gap:8px}
      .send-btn{width:42px;height:42px;border-radius:14px;border:none;background:var(--accent);color:white;display:grid;place-items:center;cursor:pointer;box-shadow:0 10px 24px rgba(255,77,50,0.35)}
      .badge-mini{background:rgba(255,255,255,0.06);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);display:inline-flex;align-items:center;gap:6px;margin-top:14px}
      .progress{height:8px;background:rgba(255,255,255,0.06);border-radius:6px;overflow:hidden;margin-top:14px}
      .progress>div{height:100%;background:linear-gradient(90deg,var(--grad1),var(--grad2));width:0%}
      #status{display:block;color:var(--muted);margin-top:10px;min-height:18px}
      #result{margin-top:16px}
      .primary{width:100%;margin-top:14px;background:linear-gradient(90deg,var(--grad1),var(--grad2));color:#fff;border:none;border-radius:12px;padding:14px;font-size:16px;font-weight:700;cursor:pointer}
      @media (max-width:720px){.title{font-size:30px}.prompt-shell{flex-direction:column;align-items:stretch}.prompt-actions{justify-content:flex-end}.sidebar{position:fixed;left:0;top:0;height:100vh;z-index:3}}
    </style>
  </head>
  <body>
    <div class="layout">
      <aside class="sidebar">
        <a class="side-brand" href="/">
          <div class="side-logo">TT</div>
          <span>TexTune</span>
        </a>
        <nav class="side-nav">
          <a href="/">홈</a>
          <a href="generate.html" class="active">음원 생성</a>
          <a href="library.html">보관함</a>
          <a id="authAction" href="login.html">로그인</a>
        </nav>
        <span id="authUser"></span>
      </aside>
      <main>
        <div class="glow" aria-hidden="true"></div>
        <section class="hero">
          <h1 class="title">여러분들만의 곡을 생성해보세요</h1>
          <div class="prompt-shell">
            <button class="icon-btn" aria-label="add option">
              <span>+</span>
            </button>
            <textarea id="prompt" placeholder="프롬프트를 입력해주세요."></textarea>
            <div class="prompt-actions">
              <button class="icon-btn" id="diceBtn" aria-label="random prompt">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="3" y="3" width="18" height="18" rx="4" fill="currentColor" opacity="0.12"/>
                  <circle cx="9" cy="9" r="1.3" fill="currentColor"/>
                  <circle cx="15" cy="9" r="1.3" fill="currentColor"/>
                  <circle cx="12" cy="12" r="1.3" fill="currentColor"/>
                  <circle cx="9" cy="15" r="1.3" fill="currentColor"/>
                  <circle cx="15" cy="15" r="1.3" fill="currentColor"/>
                </svg>
              </button>
              <button class="send-btn" id="genBtn" aria-label="start generating">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M5 12h14M13 6l6 6-6 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
          </div>
          <span id="status"></span>
          <div class="progress"><div id="bar"></div></div>
          <div id="result"></div>
        </section>
      </main>
    </div>

    <script src="js/app.js"></script>
    <script>
      (async () => {
        await hydrateAuthControls();
        await ensureAuthed();
        try {
          const v = localStorage.getItem('texttune_pre_prompt');
          if (v) {
            const el = document.getElementById('prompt');
            if (el) el.value = v;
            localStorage.removeItem('texttune_pre_prompt');
            document.getElementById('cnt').textContent = (el.value||'').length;
          }
        } catch {}
      })();

      const ta = document.getElementById('prompt');
      const cnt = document.getElementById('cnt');
      ta?.addEventListener('input', () => {
        const v = (ta.value || '').slice(0,200);
        if (v !== ta.value) ta.value = v;
        cnt.textContent = v.length;
      });

      const statusEl = document.getElementById('status');
      const barEl = document.getElementById('bar');
      const resultEl = document.getElementById('result');
      const diceBtn = document.getElementById('diceBtn');
      const samples = [
        'Make me a nostalgic synthwave track with airy pads',
        'Create a jazzy lo-fi beat with vinyl crackle and soft keys',
        'Epic orchestral score with soaring strings and big drums',
        'Warm acoustic folk song with gentle fingerpicking'
      ];

      diceBtn?.addEventListener('click', () => {
        const pick = samples[Math.floor(Math.random()*samples.length)];
        ta.value = pick;
        cnt.textContent = pick.length;
      });

      document.getElementById('genBtn').addEventListener('click', async () => {
        resultEl.innerHTML = '';
        statusEl.textContent = '요청 등록 중...';
        barEl.style.width = '0%';
        const prompt = document.getElementById('prompt').value;
        try {
          const { job_id } = await api('/v1/generations', { method: 'POST', body: { prompt } });
          statusEl.textContent = '생성 중...';
          pollJob(job_id);
        } catch (e) {
          statusEl.textContent = '오류: ' + e.message;
        }
      });

      async function pollJob(jobId) {
        const id = setInterval(async () => {
          try {
            const s = await api(`/v1/generations/${jobId}`);
            barEl.style.width = `${Math.floor((s.progress || 0) * 100)}%`;
            if (s.status === 'succeeded') {
              clearInterval(id);
              statusEl.textContent = '완료';
              const link = `/track.html?id=${encodeURIComponent(s.track_id)}`;
              resultEl.innerHTML = `<button class="primary listen-btn" type="button">감상하기</button>`;
              resultEl.querySelector('.listen-btn')?.addEventListener('click', () => {
                window.location.href = link;
              });
            } else if (s.status === 'failed') {
              clearInterval(id);
              statusEl.textContent = '실패: ' + (s.error || 'unknown');
            }
          } catch (e) {
            clearInterval(id);
            statusEl.textContent = '오류: ' + e.message;
          }
        }, 1000);
      }
    </script>
  </body>
</html>
