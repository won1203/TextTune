<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TexTune | 트랙 생성</title>
    <!-- build: generate v2 -->
    <style>
      :root{
        --bg:#0f1222; --panel:#191c33; --panel2:#14172a; --stroke:#2a2f55; --text:#e8e8f0; --muted:#aab; --brand:#8ad;
        --grad1:#a65cff; --grad2:#4b63ff;
      }
      *{box-sizing:border-box}
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
      header{position:sticky;top:0;background:#0f1222ee;backdrop-filter:saturate(150%) blur(4px);border-bottom:1px solid var(--stroke)}
      .wrap{max-width:980px;margin:0 auto;padding:16px}
      .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
      .brand{display:flex;align-items:center;gap:10px;font-weight:700}
      .badge{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--grad1),var(--grad2));display:grid;place-items:center}
      .badge span{font-size:16px}
      nav a{color:var(--brand);margin-left:14px;text-decoration:none}
      #authUser{color:var(--muted);font-size:12px;margin-left:6px}
      .panel{background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:16px;margin-top:20px}
      .tabs{display:flex;gap:16px;border-bottom:1px solid var(--stroke);margin-bottom:12px}
      .tab{padding:10px 6px;margin-bottom:-1px;border-bottom:2px solid transparent;color:#b9b9d6;cursor:pointer}
      .tab.active{color:#b78bff;border-color:#b78bff}
      .panel-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
      .btn{background:var(--panel2);color:var(--text);border:1px solid var(--stroke);border-radius:8px;padding:8px 10px;cursor:pointer}
      label{display:block;color:#cfd2ff;margin:8px 0 6px}
      textarea{width:100%;min-height:160px;background:var(--panel2);border:1px solid var(--stroke);border-radius:10px;color:var(--text);padding:12px}
      .count{color:var(--muted);text-align:right;font-size:12px;margin-top:6px}
      .actions{display:flex;gap:8px;margin-top:10px}
      .primary{width:100%;margin-top:18px;background:linear-gradient(90deg,var(--grad1),var(--grad2));color:#fff;border:none;border-radius:12px;padding:16px;font-size:18px;font-weight:800;cursor:pointer}
      .toggle{position:relative;width:46px;height:26px;background:#404565;border-radius:20px;border:1px solid var(--stroke)}
      .toggle::after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;background:#cfd2ff;border-radius:50%;transition:left .2s}
      .toggle.on::after{left:23px}
      .muted{opacity:.85}
      .progress{height:10px;background:#2a2f55;border-radius:6px;overflow:hidden}
      .progress>div{height:100%;background:#4b63ff;width:0%}
    </style>
  </head>
  <body>
    <header>
      <div class="wrap row">
        <div class="brand">
          <div class="badge"><span>🎵</span></div>
          <div>TexTune</div>
        </div>
        <nav>
          <a class="nav-btn" href="library.html">보관함</a>
          <a id="authAction" class="nav-btn" href="login.html">로그인</a>
          <span id="authUser"></span>
        </nav>
      </div>
    </header>

    <main class="wrap">
      <section class="panel">
        <div class="tabs">
          <div class="tab active">텍스트 -> 음원</div>
        </div>
        <div class="panel-head">
          <div></div>
        </div>
        <div class="panel-body">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div style="font-weight:600;color:#d5d8ff">음원 생성</div>
          </div>
          <label>프롬프트</label>
          <textarea id="prompt" placeholder="프롬프트를 입력해주세요"></textarea>
          <div class="count"><span id="cnt">0</span>/200</div>
          <button class="primary" id="genBtn">생성</button>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <span id="status" class="muted"></span>
          </div>
          <div class="progress" style="margin-top:8px"><div id="bar"></div></div>
          <div id="result" style="margin-top:12px"></div>
        </div>
      </section>
    </main>

    <script src="js/app.js"></script>
    <script>
      (async () => {
        await hydrateAuthControls();
        await ensureAuthed();
        try {
          const v = localStorage.getItem('texttune_pre_prompt');
          if (v) {
            const el = document.getElementById('prompt');
            if (el) el.value = v;
            localStorage.removeItem('texttune_pre_prompt');
            document.getElementById('cnt').textContent = (el.value||'').length;
          }
        } catch {}
      })();

      const t = document.getElementById('instToggle');
      t?.addEventListener('click', () => t.classList.toggle('on'));

      const ta = document.getElementById('prompt');
      const cnt = document.getElementById('cnt');
      ta?.addEventListener('input', () => {
        const v = (ta.value || '').slice(0,200);
        if (v !== ta.value) ta.value = v;
        cnt.textContent = v.length;
      });

      const statusEl = document.getElementById('status');
      const barEl = document.getElementById('bar');
      const resultEl = document.getElementById('result');

      document.getElementById('genBtn').addEventListener('click', async () => {
        resultEl.innerHTML = '';
        statusEl.textContent = '요청 등록 중...';
        barEl.style.width = '0%';
        const prompt = document.getElementById('prompt').value;
        try {
          const { job_id } = await api('/v1/generations', { method: 'POST', body: { prompt } });
          statusEl.textContent = '생성 중...';
          pollJob(job_id);
        } catch (e) {
          statusEl.textContent = '오류: ' + e.message;
        }
      });

      async function pollJob(jobId) {
        const id = setInterval(async () => {
          try {
            const s = await api(`/v1/generations/${jobId}`);
            barEl.style.width = `${Math.floor((s.progress || 0) * 100)}%`;
            if (s.status === 'succeeded') {
              clearInterval(id);
              statusEl.textContent = '완료';
              const link = `/track.html?id=${encodeURIComponent(s.track_id)}`;
              resultEl.innerHTML = `<button class="primary listen-btn" type="button">감상하기</button>`;
              resultEl.querySelector('.listen-btn')?.addEventListener('click', () => {
                window.location.href = link;
              });
            } else if (s.status === 'failed') {
              clearInterval(id);
              statusEl.textContent = '실패: ' + (s.error || 'unknown');
            }
          } catch (e) {
            clearInterval(id);
            statusEl.textContent = '오류: ' + e.message;
          }
        }, 1000);
      }
    </script>
  </body>
</html>
