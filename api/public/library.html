<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>보관함 | TexTune</title>
    <style>
      :root{
        --bg:#0f1222; --panel:#191c33; --panel2:#14172a; --stroke:#2a2f55; --text:#e8e8f0; --muted:#b6b9c9; --brand:#8ad;
        --grad1:#a65cff; --grad2:#4b63ff; --sidebar:#0b0d1a; --pill:#f2eaff; --pill-text:#3f2c5c;
      }
      *{box-sizing:border-box}
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text);display:flex;min-height:100vh}
      .layout{display:flex;width:100%}
      .sidebar{width:220px;min-height:100vh;background:var(--sidebar);border-right:1px solid var(--stroke);padding:18px 14px;position:sticky;top:0;align-self:flex-start}
      .side-brand{display:flex;align-items:center;gap:10px;margin-bottom:18px;font-weight:800;color:var(--text);text-decoration:none}
      .side-logo{width:34px;height:34px;border-radius:12px;background:linear-gradient(135deg,var(--grad1),var(--grad2));display:grid;place-items:center;font-weight:800;color:#fff}
      .side-nav{display:flex;flex-direction:column;gap:8px;margin-top:12px}
      .side-nav a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:var(--text);text-decoration:none;border:1px solid transparent}
      .side-nav a:hover{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.08)}
      .side-nav a.active{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.1)}
      #authUser{color:var(--muted);font-size:12px;margin-top:16px;display:block}
      .main{flex:1;padding:32px 32px 48px}
      .page-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
      .page-head h2{margin:0;font-size:28px;font-weight:800}
      #library{display:flex;flex-direction:column;gap:10px}
      #library.empty-state{display:flex;align-items:center;justify-content:center;min-height:70vh;position:relative}
      .empty-wrap{display:flex;align-items:center;justify-content:center;min-height:60vh;width:100%}
      .lib-row{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:12px 14px;display:flex;align-items:center;gap:14px;box-shadow:0 10px 24px rgba(0,0,0,0.18);}
      .lib-icon{width:40px;height:40px;border-radius:12px;background:linear-gradient(140deg,var(--grad1),var(--grad2));display:grid;place-items:center;font-weight:800;color:#fff;flex-shrink:0;}
      .lib-icon svg{width:20px;height:20px;fill:#fff;}
      .lib-main{display:flex;flex-direction:column;gap:6px;flex:1;min-width:0;}
      .lib-title{font-weight:750;font-size:16px;color:#f4f5fb;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
      .lib-sub{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
      .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:12px;background:var(--pill);color:var(--pill-text);font-weight:700;font-size:12px;}
      .meta{font-size:13px;color:var(--muted);}
      .lib-right{display:flex;align-items:center;gap:10px;flex-shrink:0;}
      .btn{border:none;border-radius:10px;padding:9px 12px;cursor:pointer;font-weight:750;font-size:13px;}
      .btn-primary{background:linear-gradient(120deg,var(--grad1),var(--grad2));color:#fff;}
      .btn-ghost{background:rgba(255,255,255,0.06);color:var(--text);}
      .btn-danger{background:#c0392b;color:#fff;}
      .more-wrap{position:relative;display:inline-flex;align-items:center;}
      .more-btn{border:none;background:rgba(255,255,255,0.06);color:var(--text);width:34px;height:34px;border-radius:10px;cursor:pointer;font-weight:800;}
      .more-menu{position:absolute;top:100%;right:0;min-width:170px;background:rgba(12,14,24,0.95);border:1px solid rgba(255,255,255,0.08);border-radius:12px;box-shadow:0 16px 40px rgba(0,0,0,0.45);padding:4px 0;display:none;z-index:2000;overflow:hidden;}
      .more-menu button,.more-menu a{all:unset;display:block;width:100%;padding:10px 12px;color:var(--text);font-size:14px;cursor:pointer;box-sizing:border-box;}
      .more-menu button:hover,.more-menu a:hover{background:rgba(255,255,255,0.08);}
      .more-menu .danger{color:#ff6b6b;}
      .empty{display:flex;align-items:center;justify-content:center;flex-direction:column;color:#b1b5c6;gap:14px;text-align:center}
      .empty-icon{width:140px;height:140px;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><circle cx="256" cy="256" r="200" fill="%230d0f1f"/><circle cx="256" cy="256" r="170" fill="%23161a33"/><circle cx="256" cy="256" r="120" fill="%230d0f1f"/><circle cx="256" cy="256" r="16" fill="%23464c6a"/><path d="M332 116v186.7c-9-5-21.7-8-35.8-8-32.1 0-58.2 16.5-58.2 36.8s26.1 36.8 58.2 36.8 58.2-16.5 58.2-36.8V188l58-12v-60l-80 16z" fill="%23b29cff"/></svg>') center/contain no-repeat;}
    </style>
  </head>
  <body>
    <div class="layout">
      <aside class="sidebar">
        <a class="side-brand" href="/">
          <div class="side-logo">TT</div>
          <span>TexTune</span>
        </a>
        <nav class="side-nav">
          <a href="/">홈</a>
          <a href="generate.html">음원 생성</a>
          <a href="library.html" class="active">보관함</a>
          <a href="playlist.html">플레이리스트</a>
          <a id="authAction" href="#">로그인</a>
        </nav>
        <span id="authUser"></span>
      </aside>
      <main class="main">
        <div class="page-head">
          <h2>내 생성 트랙 보관함</h2>
        </div>
        <div id="library"></div>
      </main>
    </div>
    <div id="globalPlayer" aria-live="polite">
      <div class="icon"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18.5 3.5v11.4a3.6 3.6 0 1 1-1.5-2.9V7.7l-6 1.5v7.7a3.6 3.6 0 1 1-1.5-2.9V5l9-2.2z"/></svg></div>
      <div class="info">
        <div class="title" id="gpTitle">재생할 트랙</div>
        <div class="meta" id="gpMeta"></div>
      </div>
      <audio id="gpAudio" controls></audio>
      <div class="actions">
        <a id="gpDownload" href="#" download>다운로드</a>
        <button id="gpClose" type="button">닫기</button>
      </div>
    </div>

    <script src="js/app.js"></script>
    <script>
      (async () => {
        await hydrateAuthControls();
        await ensureAuthed();
        await load();
      })();

      const DATE_FMT = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' };
      const TIME_FMT = { hour: '2-digit', minute: '2-digit', second: '2-digit' };

      function escapeHtml(str = '') {
        return str.replace(/[&<>"']/g, c => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
        })[c] || c);
      }

      function dateLabel(date) {
        return date.toLocaleDateString('ko-KR', DATE_FMT) + ' ' + date.toLocaleTimeString('ko-KR', TIME_FMT);
      }

      function formatDuration(sec) {
        if (typeof sec !== 'number' || !Number.isFinite(sec)) return '';
        const total = Math.max(0, Math.round(sec));
        const m = Math.floor(total / 60);
        const s = total % 60;
        return `${m}:${s.toString().padStart(2, '0')}`;
      }

      function renderEmpty(container) {
        container.classList.add('empty-state');
        container.innerHTML = `
          <div class="empty-wrap">
            <div class="empty">
              <div class="empty-icon"></div>
              <div>아직 데이터가 없습니다</div>
            </div>
          </div>
        `;
      }

      async function load() {
        const { items } = await api('/v1/library?limit=20');
        const container = document.getElementById('library');
        container.innerHTML = '';
        container.classList.remove('empty-state');
        if (!items || items.length === 0) {
          renderEmpty(container);
          return;
        }

        const iconMarkup = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18.5 3.5v11.4a3.6 3.6 0 1 1-1.5-2.9V7.7l-6 1.5v7.7a3.6 3.6 0 1 1-1.5-2.9V5l9-2.2z"/></svg>';

        items.forEach(t => {
          const title = t.prompt_title || `트랙 #${t.id.slice(0, 8)}`;
          const safeTitle = escapeHtml(title);
          const meta = `${t.samplerate ?? '?'}Hz · ${t.format || '?'} · ${formatDuration(t.duration) || '?:??'}`;
          const badge = '텍스트-투-음악';
          const created = dateLabel(new Date(t.created_at));
          const row = document.createElement('div');
          row.className = 'lib-row';
          row.innerHTML = `
            <div class="lib-icon">${iconMarkup}</div>
            <div class="lib-main">
              <div class="lib-title"><a href="track.html?id=${t.id}" style="color:inherit;text-decoration:none;">${safeTitle}</a></div>
              <div class="lib-sub">
                <span class="pill">${escapeHtml(badge)}</span>
                <span class="pill">${escapeHtml(meta)}</span>
                <span class="meta">${created}</span>
              </div>
            </div>
            <div class="lib-right">
              <button class="btn btn-ghost" data-play="${t.id}">재생</button>
              <div class="more-wrap">
                <button class="more-btn" aria-label="더 보기" data-more="${t.id}">⋯</button>
                <div class="more-menu" data-menu="${t.id}">
                  <a href="${t.download_url}" download>다운로드</a>
                  <button type="button" data-add-playlist="${t.id}">플레이리스트 담기</button>
                  <button type="button" class="danger" data-id="${t.id}">삭제</button>
                </div>
              </div>
            </div>
          `;
          const playBtn = row.querySelector('button[data-play]');
          const iconEl = row.querySelector('.lib-icon');
          const triggerPlay = () => {
            if (window.setGlobalPlayerTrack) {
              window.setGlobalPlayerTrack({
                id: t.id,
                title: t.prompt_title || t.prompt_raw || '트랙',
                audio_url: t.audio_url,
                download_url: t.download_url,
                format: t.format,
                samplerate: t.samplerate,
                duration: t.duration,
                created_at: t.created_at,
                prompt_raw: t.prompt_raw,
                prompt_expanded: t.prompt_expanded,
              });
            }
          };
          if (playBtn) playBtn.addEventListener('click', (ev) => { ev.preventDefault(); triggerPlay(); });
          if (iconEl) iconEl.addEventListener('click', (ev) => { ev.preventDefault(); triggerPlay(); });
          const moreBtn = row.querySelector(`button[data-more="${t.id}"]`);
          const menu = row.querySelector(`.more-menu[data-menu="${t.id}"]`);
          if (moreBtn && menu) {
            moreBtn.addEventListener('click', (ev) => {
              ev.preventDefault();
              document.querySelectorAll('.more-menu').forEach(m => { if (m !== menu) m.style.display = 'none'; });
              menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            });
          }
          const delBtn = row.querySelector('button[data-id]');
          if (delBtn) {
            delBtn.addEventListener('click', async (e) => {
              const id = e.target.getAttribute('data-id');
              if (!confirm('해당 음원을 삭제하시겠습니까?')) return;
              await fetch(`/v1/library/${id}`, { method: 'DELETE', credentials: 'include' });
              await load();
            });
          }
          const addBtn = row.querySelector(`button[data-add-playlist="${t.id}"]`);
          if (addBtn) {
            addBtn.addEventListener('click', (ev) => {
              ev.preventDefault();
              if (window.openSelectPlaylistModal) {
                window.openSelectPlaylistModal({
                  id: t.id,
                  prompt_title: t.prompt_title,
                  prompt_raw: t.prompt_raw,
                  prompt_expanded: t.prompt_expanded,
                  audio_url: t.audio_url,
                  download_url: t.download_url,
                  format: t.format,
                  samplerate: t.samplerate,
                  duration: t.duration,
                  created_at: t.created_at,
                });
              }
              if (menu) menu.style.display = 'none';
            });
          }
          container.appendChild(row);
        });

        if (!window.__moreMenuOutsideHandler) {
          document.addEventListener('click', (ev) => {
            if (!ev.target.closest('.more-wrap')) {
              document.querySelectorAll('.more-menu').forEach(m => { m.style.display = 'none'; });
            }
          });
          window.__moreMenuOutsideHandler = true;
        }
      }

      function openGlobalPlayer(track) {
        const gp = document.getElementById('globalPlayer');
        const audio = document.getElementById('gpAudio');
        const title = document.getElementById('gpTitle');
        const meta = document.getElementById('gpMeta');
        const dl = document.getElementById('gpDownload');
        if (!gp || !audio || !title || !meta || !dl) return;
        title.textContent = track.prompt_title || track.prompt_raw || '재생할 트랙';
        meta.textContent = `${track.format || '?'} · ${track.samplerate || '?'}Hz · ${formatDuration(track.duration) || '?:??'} · ${dateLabel(new Date(track.created_at))}`;
        audio.src = track.audio_url;
        dl.href = track.download_url;
        gp.style.display = 'flex';
        audio.play().catch(() => {});
      }

      (function initGlobalPlayerControls(){
        const gp = document.getElementById('globalPlayer');
        const audio = document.getElementById('gpAudio');
        const closeBtn = document.getElementById('gpClose');
        if (closeBtn && audio && gp) {
          closeBtn.onclick = () => {
            audio.pause();
            gp.style.display = 'none';
          };
        }
      })();
    </script>
  </body>
</html>
